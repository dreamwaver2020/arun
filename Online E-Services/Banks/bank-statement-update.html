<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bank Statement Manager â€” Final (Recent Date + Pagination)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .fade-in { animation: fadeIn 220ms ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px);} to { opacity: 1; transform: translateY(0);} }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; }
    .details-row { background: #fbfbff; }
    .btn { cursor: pointer; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen antialiased">
  <div class="max-w-6xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-3xl font-bold text-sky-700">ğ“‘ğ“ªğ“·ğ“´ ğ“¡ğ“®ğ“¬ğ“¸ğ“»ğ“­ğ“¼</h1>
      <p class="text-sm text-gray-600">ğ“’ğ“µğ“²ğ“¬ğ“´ "ğ“¥ğ“²ğ“®ğ”€" ğ“½ğ“¸ ğ“¼ğ“®ğ“® ğ“­ğ“®ğ“½ğ“ªğ“²ğ“µğ“®ğ“­ ğ“½ğ“»ğ“ªğ“·ğ“¼ğ“ªğ“¬ğ“½ğ“²ğ“¸ğ“·ğ“¼.</p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <section class="lg:col-span-2 bg-white p-6 rounded-2xl shadow">
        <form id="recordForm" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
          <div>
            <label class="block text-xs text-gray-600">Bank</label>
            <select id="bankSelect" class="mt-1 w-full p-2 border rounded">
              <option>ğ‚ğšğ¬ğ¡ ğ¢ğ§ ğ¡ğšğ§ğ</option>
              <option>ğ-ğ’ğğ°ğš</option>
              <option>ğğ‚ğğ‹</option>
              <option>ğ’ğ®ğ§ğ«ğ¢ğ¬ğ</option>
              <option>ğğğŸğ¬ğœğ®ğ§</option>
            </select>
          </div>
          <div>
            <label class="block text-xs text-gray-600">Date</label>
            <input id="dateInput" type="date" class="mt-1 w-full p-2 border rounded" />
          </div>
          <div>
            <label class="block text-xs text-gray-600">Opening Balance</label>
            <input id="openingInput" type="number" step="0.01" class="mt-1 w-full p-2 border rounded text-right mono" readonly />
            <div class="text-xs text-gray-400 mt-1">Auto from previous closing</div>
          </div>

          <div class="md:col-span-2">
            <label class="block text-xs text-gray-600">Today's Transaction</label>
            <div class="mt-1 flex items-center gap-4 border rounded p-2">
              <label class="flex items-center gap-1 text-sm">
                <input type="radio" name="txnType" value="receipt" id="receiptRadio" checked>
                <span>Receipt</span>
              </label>
              <label class="flex items-center gap-1 text-sm">
                <input type="radio" name="txnType" value="payment" id="paymentRadio">
                <span>Payment</span>
              </label>
            </div>
            <div class="mt-3">
              <input id="amountInput" type="number" placeholder="Enter amount" step="0.01" class="mt-1 w-full p-2 border rounded text-right mono" />
            </div>
          </div>

          <div class="md:col-span-5 flex items-center justify-between mt-2">
            <div>
              <div class="text-xs text-gray-600">Preview Closing (auto)</div>
              <div id="closingView" class="text-2xl font-semibold mono">0.00</div>
            </div>
            <div class="flex items-center gap-2">
              <button id="addBtn" class="px-4 py-2 bg-sky-600 text-white rounded hover:bg-sky-700">Add Transaction</button>
              <button id="clearBtn" type="button" class="px-4 py-2 border rounded">Clear</button>
              <button id="exportBtn" type="button" class="px-4 py-2 border rounded">Export CSV</button>
            </div>
          </div>
        </form>

        <section class="mt-6">
          <div class="overflow-x-auto bg-white rounded-xl shadow p-3">
            <table id="summaryTable" class="w-full table-auto">
              <thead>
                <tr class="text-left text-sm text-gray-500 border-b">
                  <th class="p-3">Bank</th>
                  <th class="p-3">Date</th>
                  <th class="p-3 text-right">Opening</th>
                  <th class="p-3 text-right">Total Receipt</th>
                  <th class="p-3 text-right">Total Payment</th>
                  <th class="p-3 text-right">Closing</th>
                  <th class="p-3">Details</th>
                </tr>
              </thead>
              <tbody id="summaryBody">
                <tr><td colspan="7" class="p-4 text-center text-gray-500">No transactions yet.</td></tr>
              </tbody>
            </table>
          </div>
        </section>
      </section>

      <aside class="bg-white p-6 rounded-2xl shadow">
        <div class="mb-4">
          <label class="block text-xs text-gray-600">Filter (bank or date)</label>
          <input id="searchInput" placeholder="e.g., Esewa or 2025-10-31" class="mt-1 w-full p-2 border rounded" />
        </div>
        <div class="space-y-3">
          <div class="flex items-center justify-between">
            <div class="text-sm text-gray-600">Summary rows</div>
            <div id="countBadge" class="text-sm mono">0</div>
          </div>
          <div class="text-xs text-gray-500">Notes: Each row is a day's combined totals for a bank. Click "View" to expand details.</div>
        </div>
      </aside>
    </div>

    <footer class="mt-6 text-sm text-gray-500 text-center">Data stored locally in this browser only. Export CSV for backup.</footer>
  </div>

  <div id="toast" class="fixed right-6 bottom-6 bg-sky-600 text-white px-4 py-2 rounded-lg shadow hidden"></div>

<script>
(function(){
  const STORAGE_KEY = 'bank_stmt_final_v1';
  const bankSelect = document.getElementById('bankSelect');
  const dateInput = document.getElementById('dateInput');
  const openingInput = document.getElementById('openingInput');
  const amountInput = document.getElementById('amountInput');
  const closingView = document.getElementById('closingView');
  const addBtn = document.getElementById('addBtn');
  const clearBtn = document.getElementById('clearBtn');
  const exportBtn = document.getElementById('exportBtn');
  const summaryBody = document.getElementById('summaryBody');
  const searchInput = document.getElementById('searchInput');
  const countBadge = document.getElementById('countBadge');
  const toast = document.getElementById('toast');

  let typeSelect = { value: 'receipt' };
  document.getElementById('receiptRadio').addEventListener('change', () => typeSelect.value = 'receipt');
  document.getElementById('paymentRadio').addEventListener('change', () => typeSelect.value = 'payment');

  let summaries = [];
  let currentPage = 1;
  const recordsPerPage = 10;

  function showToast(msg, ms=2000){
    toast.textContent = msg;
    toast.classList.remove('hidden');
    setTimeout(()=> toast.classList.add('hidden'), ms);
  }

  function load(){
    const raw = localStorage.getItem(STORAGE_KEY);
    summaries = raw ? JSON.parse(raw) : [];
    countBadge.textContent = summaries.length;
  }

  function save(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(summaries));
    countBadge.textContent = summaries.length;
  }

  function todayISO(){ return new Date().toISOString().slice(0,10); }

  function getBankSummaries(bank){
    return summaries.filter(s => s.bank === bank).sort((a,b) => a.date.localeCompare(b.date));
  }

  function recomputeBank(bank){
    const list = getBankSummaries(bank);
    let running = 0;
    for (let i=0;i<list.length;i++){
      const s = list[i];
      s.opening = running;
      let totR = 0, totP = 0;
      for (const d of s.details){
        if(d.type==='receipt') totR += d.amount;
        else totP += d.amount;
      }
      s.totalReceipt = totR;
      s.totalPayment = totP;
      s.closing = s.opening + totR - totP;
      running = s.closing;
      const idx = summaries.findIndex(x => x.bank===s.bank && x.date===s.date);
      if(idx!==-1) summaries[idx] = s;
    }
  }

  function recomputeAll(){
    const banks = Array.from(new Set(summaries.map(s=>s.bank)));
    for(const b of banks) recomputeBank(b);
  }

  function findSummary(bank,date){
    return summaries.find(s => s.bank===bank && s.date===date);
  }

  function createSummary(bank,date,opening){
    const s = { bank, date, opening: opening||0, totalReceipt:0, totalPayment:0, closing: opening||0, details: [], createdAt: new Date().toISOString() };
    summaries.push(s);
    return s;
  }

  function formatMoney(n){ return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }

  function updatePreview(){
    const bank = bankSelect.value;
    const date = dateInput.value || todayISO();
    const amt = Number(amountInput.value) || 0;
    const type = typeSelect.value;
    const list = getBankSummaries(bank).filter(s => s.date < date);
    const last = list.length ? list[list.length-1].closing : 0;
    const existing = findSummary(bank,date);
    const baseOpening = existing ? existing.opening : last;
    const currentClosing = baseOpening + (existing ? existing.totalReceipt - existing.totalPayment : 0) + (type==='receipt'? amt : -amt);
    closingView.textContent = formatMoney(currentClosing);
  }

  // âœ… Render with DESCENDING DATE ORDER
  function render(filter = '') {
    const ft = (filter || '').toLowerCase();
    const list = summaries.slice().sort((a,b)=> {
      if (a.date !== b.date) return b.date.localeCompare(a.date); // recent first
      if (a.bank !== b.bank) return a.bank.localeCompare(b.bank);
      return (a.createdAt || '').localeCompare(b.createdAt || '');
    });
    const filtered = list.filter(s => (s.bank+' '+s.date).toLowerCase().includes(ft));

    const totalPages = Math.ceil(filtered.length / recordsPerPage);
    if (currentPage > totalPages) currentPage = totalPages || 1;
    const startIndex = (currentPage - 1) * recordsPerPage;
    const pageItems = filtered.slice(startIndex, startIndex + recordsPerPage);

    if (!filtered.length) {
      summaryBody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-500">No transactions yet.</td></tr>';
      return;
    }

    summaryBody.innerHTML = pageItems.map(s => `
      <tr class="border-b">
        <td class="p-3">${s.bank}</td>
        <td class="p-3">${s.date}</td>
        <td class="p-3 text-right mono">${formatMoney(s.opening)}</td>
        <td class="p-3 text-right mono">${formatMoney(s.totalReceipt)}</td>
        <td class="p-3 text-right mono">${formatMoney(s.totalPayment)}</td>
        <td class="p-3 text-right mono font-semibold">${formatMoney(s.closing)}</td>
        <td class="p-3"><button class="viewBtn px-2 py-1 border rounded btn" data-bank="${s.bank}" data-date="${s.date}">View</button></td>
      </tr>
      <tr class="details-row hidden" id="details-${s.bank}-${s.date}">
        <td colspan="7" class="p-3">
          <strong>Transactions:</strong>
          <ul>
            ${s.details.map(d=>`<li class="mono">${d.time} â€” ${d.type.toUpperCase()} ${formatMoney(d.amount)} <button class="delTxn ml-2 text-red-600" data-bank="${s.bank}" data-date="${s.date}" data-id="${d.id}">Delete</button></li>`).join('') || '<li class="text-gray-500">No details</li>'}
          </ul>
        </td>
      </tr>`).join('');

    const paginationHTML = `
      <tr>
        <td colspan="7" class="p-3 text-center">
          <button id="prevPage" class="px-3 py-1 border rounded mr-2" ${currentPage===1?'disabled':''}>Prev</button>
          <span class="text-sm text-gray-600">Page ${currentPage} of ${totalPages}</span>
          <button id="nextPage" class="px-3 py-1 border rounded ml-2" ${currentPage===totalPages?'disabled':''}>Next</button>
        </td>
      </tr>`;
    summaryBody.innerHTML += paginationHTML;

    document.getElementById('prevPage')?.addEventListener('click', ()=>{ if(currentPage>1){ currentPage--; render(filter); }});
    document.getElementById('nextPage')?.addEventListener('click', ()=>{ if(currentPage<totalPages){ currentPage++; render(filter); }});

    Array.from(document.getElementsByClassName('viewBtn')).forEach(btn=>{
      btn.addEventListener('click',(e)=>{
        const bank=e.currentTarget.dataset.bank;
        const date=e.currentTarget.dataset.date;
        const el=document.getElementById(`details-${bank}-${date}`);
        if(!el)return;
        el.classList.toggle('hidden');
      });
    });

    Array.from(document.getElementsByClassName('delTxn')).forEach(btn=>{
      btn.addEventListener('click',(e)=>{
        const bank=e.currentTarget.dataset.bank;
        const date=e.currentTarget.dataset.date;
        const id=e.currentTarget.dataset.id;
        if(!confirm('Delete this transaction?'))return;
        const s=findSummary(bank,date);
        if(!s)return;
        s.details=s.details.filter(d=>d.id!==id);
        if(s.details.length===0){ summaries=summaries.filter(x=>!(x.bank===bank&&x.date===date)); }
        recomputeBank(bank);
        save();
        render(searchInput.value.trim());
        showToast('Deleted transaction');
      });
    });
  }

  function addTransaction(e){
    e.preventDefault();
    const bank = bankSelect.value;
    const date = dateInput.value || todayISO();
    let amt = Number(amountInput.value) || 0;
    if(amt <= 0) return showToast('Enter amount > 0');
    const type = typeSelect.value;
    let s = findSummary(bank,date);
    if(!s){
      const prev = getBankSummaries(bank).filter(x=>x.date < date);
      const lastClosing = prev.length ? prev[prev.length-1].closing : 0;
      s = createSummary(bank,date,lastClosing);
    }
    const detail = { id: 't'+Date.now(), time: new Date().toLocaleString(), type, amount: amt };
    s.details.push(detail);
    recomputeBank(bank);
    save();
    render(searchInput.value.trim());
    openingInput.value = getLastClosingValue(bankSelect.value, date);
    amountInput.value = '';
    updatePreviewAndClosing(bank,date);
    showToast('Transaction added');
  }

  function getLastClosingValue(bank, date){
    const list = getBankSummaries(bank).filter(s=>s.date <= date);
    return list.length ? list[list.length-1].closing : 0;
  }

  function updatePreviewAndClosing(bank, date){
    const dateVal = date || dateInput.value || todayISO();
    const amt = Number(amountInput.value) || 0;
    const type = typeSelect.value;
    const list = getBankSummaries(bank).filter(s => s.date < dateVal);
    const last = list.length ? list[list.length-1].closing : 0;
    const existing = findSummary(bank,dateVal);
    const baseOpening = existing ? existing.opening : last;
    const currTotalR = existing ? existing.totalReceipt : 0;
    const currTotalP = existing ? existing.totalPayment : 0;
    const currClosing = baseOpening + currTotalR - currTotalP + (type==='receipt'? amt : -amt);
    closingView.textContent = formatMoney(currClosing);
  }

  function exportCSV(){
    const rows = [];
    rows.push(['Bank','Date','Opening','TotalReceipt','TotalPayment','Closing']);
    for(const s of summaries.sort((a,b)=>b.date.localeCompare(a.date))){
      rows.push([s.bank,s.date,s.opening,s.totalReceipt,s.totalPayment,s.closing]);
    }
    rows.push([]);
    rows.push(['Bank','Date','TxnID','Time','Type','Amount']);
    for(const s of summaries){
      for(const d of s.details){
        rows.push([s.bank,s.date,d.id,d.time,d.type,d.amount]);
      }
    }
    const csvContent = rows.map(r=>r.map(cell=>`"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csvContent], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'bank_summary.csv'; document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },1000);
  }

  function init(){
    dateInput.value = todayISO();
    load();
    recomputeAll();
    openingInput.value = getLastClosingValue(bankSelect.value, dateInput.value);
    updatePreview();
    render();

    bankSelect.addEventListener('change', ()=>{ openingInput.value = getLastClosingValue(bankSelect.value, dateInput.value); updatePreview(); });
    dateInput.addEventListener('change', ()=>{ openingInput.value = getLastClosingValue(bankSelect.value, dateInput.value); updatePreview(); });
    amountInput.addEventListener('input', ()=> updatePreview());
    document.getElementById('receiptRadio').addEventListener('change', ()=> updatePreview());
    document.getElementById('paymentRadio').addEventListener('change', ()=> updatePreview());
    addBtn.addEventListener('click', addTransaction);
    clearBtn.addEventListener('click', (e)=>{ e.preventDefault(); amountInput.value=''; updatePreview(); });
    exportBtn.addEventListener('click', exportCSV);
    searchInput.addEventListener('input', e=> render(e.target.value.trim()));
  }

  init();
})();
</script>
</body>
</html>
